---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

require(tidyverse)
require(tidymodels)
require(data.table)
require(data.tree)
require(DataExplorer)
require(C50)
require(indicspecies)
require(doParallel)
require(philentropy)
require(dplyr)

source("CodeUsingTreeFunctions.R")
source("./_functions/_TabletoTree.R")
source("./_functions/_TreetoTable.R")
source("./_functions/_VegdatSUsummary.R")
source("./_functions/_spp_importance.R")
```


```{r Hier.data meta data}
head(Hier.data)
dim(Hier.data)
names(Hier.data)

sapply(Hier.data, function(x) length(unique(x)))
```


```{r List of SiteUnits for each level of Hierchy}

# Decided not to do it this way

uniqueClasses <- unique(Hier.data$Class)
print(uniqueClasses)


# SiteUnits_per_Class_1 <- lapply(uniqueClasses, function(x) unique(Hier.data %>% filter(Class == x) %>% select(SiteUnit)))

SiteUnits_in_Class <- aggregate(SiteUnit ~ Class, data = Hier.data, unique)
SiteUnits_in_Order <- aggregate(SiteUnit ~ Order, data = Hier.data, unique)
SiteUnits_in_Suborder <- aggregate(SiteUnit ~ Suborder, data = Hier.data, unique)

SUTab <- fread("./BEC_ReportR/Classification_tables/ALLBECSU_2021_SU.csv")
SUTab$SiteUnit <-  trimws(SUTab$SiteUnit)

SiteUnits_in_Class$PlotNumber <- SUTab$PlotNumber[SUTab$SiteUnit %in% SiteUnits_in_Class$SiteUnit]
PlotNumbers_in_Order <- SUTab$PlotNumber[SUTab$SiteUnit %in% SiteUnits_in_Order$SiteUnit]
PlotNumbers_in_Suborder <- SUTab$PlotNumber[SUTab$SiteUnit %in% SiteUnits_in_Suborder$SiteUnit]

PlotNumbers_in_Class

```


```{r Join site numbers with Plots}

Hier.data
SUTab

#jointdataset <- merge(Hier.data, SUTab, by = "SiteUnit")
jointdataset <- inner_join(SUTab, Hier.data, by = "SiteUnit")

jointdataset <- jointdataset[order(jointdataset$SiteUnit),]
Hier.data <- Hier.data[order(Hier.data$SiteUnit),]
SUTab <- SUTab[order(SUTab$SiteUnit)]
```


```{r}
# Alternative

level <- "Order"

unique_levels <- unique(Hier.data[[level]])
print(unique_levels)

level_rows <- Hier.data %>% filter(Order == "ORDER Poputre" )
site_units <- unique(level_rows$SiteUnit)
plot_numbers_in_level <- SUTab$PlotNumber[SUTab$SiteUnit %in% site_units] 

print(plot_numbers_in_level)

createReportData <- function(level_name) {
  
  level_rows <- Hier.data %>% filter(Order == "ORDER Poputre" )
  print(level_rows)
  
  # Levels
  site_units <- unique(level_rows$SiteUnit)
  classes <- unique(level_rows$Class)
  orders <- unique(level_rows$Order)
  sub_orders <- unique(level_rows$Suborder)
  alliances <- unique(level_ros$Alliance)
  associations <- unique(level_rows$Assoc)
  
  # Categorical Variables
  species <- unique(level_rows$Species)
  
  # Variables
  mean_cover <- level_rows$MeanCov
  constancy <- level_rows$Constancy
  number_of_plots <- level_rows$nPlots
  
  # Aggregated Variables
  average_mean_cover <- mean(mean_cover)
  average_constancy <- mean(constancy)
  total_number_of_plots <- sum(number_of_plots)
  
  # Look up plots
  plot_numbers_in_level <- SUTab$PlotNumber[SUTab$SiteUnit %in% site_units$SiteUnit] 
  
  # Get relevant plot data rows from each Plot data file
 
  
}

levelName <- unique_levels[[4]]
createReportData(levelName)

lapply(uniqueClasses, createReportData(levelName))

```

```{r Inspect classificaiton files}

```



## Playground

```{r}

# Hier file

SiteUnits <- c("A", "B", "C", "D", "Z")
Order <- c(1,2,3,4, 26)

df <- data.frame(SiteUnits, Order)

# Plot file

SiteUnits <- c("A", "D", "C", "B", "E", "F", "A", "D")
Plots <- c("a", "d", "c", "b", "e", "f", "a", "d")

# Expected output

df2 <- data.frame(SiteUnits, Plots)

df2 %>% filter(SiteUnits == "A")

jointdataset <- merge(df, df2, by = 'SiteUnits')

print(df2)
print(jointdataset)

```

```{r}
SUTab$SiteUnit %>% unique %>% length
SUTab$SiteUnit %>% length

SUTab$PlotNumber %>% unique %>% length
SUTab$PlotNumber %>% length

Hier.data$SiteUnit %>% unique %>% length
Hier.data$SiteUnit %>% length

Hier.data$Order %>% unique %>% length
Hier.data$Order %>% length


```

```{r}
jointdataset <- merge(df, df2, by = 'SiteUnits')
print(jointdataset)

left_join_dataset = left_join(df, df2, by = 'SiteUnits')
print(left_join_dataset)
```

